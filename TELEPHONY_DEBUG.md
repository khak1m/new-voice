# Диагностика телефонии - Пошаговая инструкция

## Проблема
Вызов на номер +7 934 662-08-75 не проходит.

---

## Шаг 1: Проверка Voice Agent на сервере

### 1.1 Подключитесь к серверу
```bash
ssh root@77.233.212.58
```

### 1.2 Проверьте что агент запущен
```bash
# Проверить процессы
ps aux | grep simple_agent

# Или проверить через systemd (если настроен)
sudo systemctl status new-voice-agent
```

**Результат:** 
- [ ] Агент запущен
- [ ] Агент НЕ запущен

### 1.3 Если агент НЕ запущен - запустите его
```bash
cd /root/new-voice
source venv/bin/activate
python -m src.voice_agent.simple_agent dev
```

**Что должно появиться:**
```
[Agent] Starting worker...
[Agent] Connected to LiveKit...
[Agent] Waiting for jobs...
```

---

## Шаг 2: Проверка переменных окружения

### 2.1 Проверьте .env файл
```bash
cd /root/new-voice
cat .env | grep -E "LIVEKIT|DEEPGRAM|CARTESIA"
```

**Должны быть:**
- LIVEKIT_URL=wss://...
- LIVEKIT_API_KEY=...
- LIVEKIT_API_SECRET=...
- DEEPGRAM_API_KEY=...
- CARTESIA_API_KEY=...

**Результат:**
- [ ] Все ключи на месте
- [ ] Какие-то ключи отсутствуют: _______________

---

## Шаг 3: Проверка настроек MTS Exolve

### 3.1 Зайдите в личный кабинет MTS Exolve
https://lk.exolve.ru/

### 3.2 Проверьте SIP Trunk "prosto voice"
- Перейдите в раздел "SIP Trunks"
- Найдите trunk "prosto voice"

**Проверьте:**
- [ ] Trunk активен (статус: включен)
- [ ] Номер +7 934 662-08-75 привязан к trunk
- [ ] Переадресация настроена на: `55fzatq1dd8@sip.livekit.cloud`

### 3.3 Проверьте настройки переадресации
В настройках номера должно быть:
- **Тип:** Переадресация на SIP URI
- **URI:** `55fzatq1dd8@sip.livekit.cloud`

**Результат:**
- [ ] Всё настроено правильно
- [ ] Есть проблемы: _______________

---

## Шаг 4: Проверка настроек LiveKit

### 4.1 Зайдите в LiveKit Cloud Dashboard
https://cloud.livekit.io/

### 4.2 Проверьте SIP Inbound Trunk
- Перейдите в раздел "SIP"
- Найдите trunk "MTS Exolve Inbound" (ID: ST_ZrtCkMpnDSPC)

**Проверьте:**
- [ ] Trunk существует
- [ ] SIP URI: `55fzatq1dd8@sip.livekit.cloud`
- [ ] Allowed Numbers: содержит `+79346620875` или `*` (любые номера)

### 4.3 Проверьте Dispatch Rule
- Найдите правило "MTS Exolve Inbound" (ID: SDR_GyBxoB4KiNq6)

**Проверьте:**
- [ ] Rule активно
- [ ] Trunk: MTS Exolve Inbound
- [ ] Agent Name: `voice-agent`
- [ ] Room Prefix: `call-`

**Результат:**
- [ ] Всё настроено правильно
- [ ] Есть проблемы: _______________

---

## Шаг 5: Проверка имени агента

### 5.1 Проверьте как запущен агент
```bash
# Посмотрите логи агента
cd /root/new-voice
source venv/bin/activate
python -m src.voice_agent.simple_agent dev
```

**В логах должно быть:**
```
Worker name: voice-agent
```

### 5.2 Если имя агента другое
Нужно либо:
- Изменить имя в Dispatch Rule на то, что в логах
- Или запустить агента с правильным именем

**Результат:**
- [ ] Имя совпадает: `voice-agent`
- [ ] Имя НЕ совпадает: _______________

---

## Шаг 6: Тестовый звонок

### 6.1 Убедитесь что агент запущен
```bash
# Агент должен быть запущен и показывать:
[Agent] Waiting for jobs...
```

### 6.2 Позвоните на номер
Позвоните с мобильного на: **+7 934 662-08-75**

### 6.3 Что происходит?
- [ ] Звонок идёт, но никто не отвечает (гудки)
- [ ] Звонок сразу сбрасывается
- [ ] Бот отвечает, но не слышит меня
- [ ] Бот отвечает и всё работает! ✅
- [ ] Другое: _______________

---

## Шаг 7: Проверка логов

### 7.1 Логи Voice Agent
```bash
# Смотрите логи агента во время звонка
# Должны появиться сообщения о входящем звонке
```

**Что должно быть в логах:**
```
[Agent] New job received: call-79XXXXXXXXX
[Agent] Подключен к комнате: call-79XXXXXXXXX
[Agent] Агент запущен, ожидаю голос...
```

### 7.2 Логи LiveKit
Зайдите в LiveKit Dashboard → Rooms
- Проверьте появилась ли комната `call-79XXXXXXXXX`
- Проверьте логи комнаты

**Результат:**
- [ ] Комната создалась
- [ ] Комната НЕ создалась
- [ ] Логи показывают ошибку: _______________

---

## Шаг 8: Частые проблемы и решения

### Проблема 1: Агент не получает входящие звонки
**Причина:** Имя агента не совпадает с Dispatch Rule

**Решение:**
1. Проверьте имя агента в логах
2. Измените Agent Name в Dispatch Rule на правильное

### Проблема 2: Звонок сбрасывается сразу
**Причина:** MTS Exolve не может достучаться до LiveKit

**Решение:**
1. Проверьте SIP URI в MTS Exolve: `55fzatq1dd8@sip.livekit.cloud`
2. Проверьте что trunk активен

### Проблема 3: Бот не отвечает
**Причина:** Агент не запущен или упал

**Решение:**
1. Перезапустите агента
2. Проверьте логи на ошибки

### Проблема 4: Бот отвечает, но не слышит
**Причина:** Проблема с STT (Deepgram)

**Решение:**
1. Проверьте DEEPGRAM_API_KEY в .env
2. Проверьте баланс на Deepgram

---

## Следующие шаги

После выполнения всех шагов, сообщите:
1. На каком шаге возникла проблема
2. Что показывают логи
3. Скриншоты настроек (если нужно)

Я помогу решить проблему!
