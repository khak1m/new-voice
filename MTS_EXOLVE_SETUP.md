# Настройка MTS Exolve для входящих звонков

## Проблема
При звонке на +7 934 662-08-75 слышно "Абонент недоступен"

## Причина
Номер не настроен для приёма входящих звонков или не привязан к SIP Trunk.

---

## Решение: Пошаговая настройка

### Шаг 1: Войдите в личный кабинет
https://lk.exolve.ru/

Логин: ваш email
Пароль: ваш пароль

---

### Шаг 2: Проверьте статус номера

1. Перейдите в раздел **"Номера"** (в левом меню)
2. Найдите номер **+7 934 662-08-75**
3. Проверьте статус:
   - ✅ Должен быть: **Активен** (зелёный)
   - ❌ Если: **Заблокирован** или **Приостановлен** - активируйте номер

---

### Шаг 3: Проверьте баланс

1. В верхнем правом углу посмотрите баланс
2. Баланс должен быть **положительным**
3. Если баланс отрицательный - пополните счёт

---

### Шаг 4: Настройте маршрутизацию входящих звонков

#### Вариант A: Через SIP Trunk (рекомендуется)

1. Кликните на номер **+7 934 662-08-75**
2. Перейдите на вкладку **"Маршрутизация"** или **"Настройки"**
3. В разделе **"Входящие звонки"** выберите:
   - **Тип:** SIP Trunk
   - **SIP Trunk:** prosto voice
4. Нажмите **"Сохранить"**

#### Вариант B: Прямая переадресация на SIP URI

1. Кликните на номер **+7 934 662-08-75**
2. Перейдите на вкладку **"Маршрутизация"** или **"Настройки"**
3. В разделе **"Входящие звонки"** выберите:
   - **Тип:** Переадресация на SIP URI
   - **SIP URI:** `55fzatq1dd8@sip.livekit.cloud`
4. Нажмите **"Сохранить"**

---

### Шаг 5: Проверьте SIP Trunk "prosto voice"

1. Перейдите в раздел **"SIP Trunks"** (в левом меню)
2. Найдите trunk **"prosto voice"**
3. Проверьте:
   - ✅ Статус: **Активен**
   - ✅ Тип: **Исходящий и входящий** (или **Bidirectional**)
   - ✅ В разделе **"Маршрутизация исходящих"** должен быть адрес:
     ```
     55fzatq1dd8@sip.livekit.cloud
     ```

4. Если trunk не активен - активируйте его
5. Если адреса нет - добавьте:
   - **Host:** `sip.livekit.cloud`
   - **Username:** `55fzatq1dd8`
   - **Port:** `5060` (по умолчанию)

---

### Шаг 6: Проверьте настройки безопасности

В некоторых случаях MTS Exolve блокирует переадресацию на внешние SIP URI.

1. Перейдите в **"Настройки"** → **"Безопасность"**
2. Убедитесь что:
   - ✅ Разрешена переадресация на внешние SIP URI
   - ✅ Нет блокировки по IP-адресам

---

### Шаг 7: Тестовый звонок

После настройки подождите **1-2 минуты** (изменения применяются не мгновенно).

Затем позвоните на **+7 934 662-08-75**

**Ожидаемый результат:**
- Звонок должен идти (гудки)
- Через 2-3 секунды должен ответить бот
- Бот должен сказать: "Здравствуйте! Чем могу помочь?"

---

## Частые проблемы

### Проблема 1: "Абонент недоступен"
**Причина:** Номер не активирован или нет маршрутизации

**Решение:**
1. Активируйте номер
2. Настройте маршрутизацию (Шаг 4)

### Проблема 2: "Номер не обслуживается"
**Причина:** Отрицательный баланс

**Решение:**
1. Пополните баланс

### Проблема 3: Звонок идёт, но никто не отвечает
**Причина:** SIP URI неправильный или LiveKit не получает звонок

**Решение:**
1. Проверьте SIP URI: `55fzatq1dd8@sip.livekit.cloud`
2. Проверьте что Voice Agent запущен на сервере
3. Проверьте логи LiveKit Dashboard

### Проблема 4: "Все операторы заняты"
**Причина:** SIP Trunk не может подключиться к LiveKit

**Решение:**
1. Проверьте что LiveKit Inbound Trunk настроен
2. Проверьте Dispatch Rule в LiveKit

---

## Альтернативный способ: Настройка через API

Если у вас есть API ключ MTS Exolve, можно настроить через API:

### Способ 1: Используя Python скрипт (рекомендуется)

1. Получите API ключ в личном кабинете MTS Exolve
2. Добавьте в `.env` файл:
```bash
MTS_EXOLVE_API_KEY=ваш_api_ключ
```

3. Запустите скрипт на сервере:
```bash
cd /root/new-voice
source venv/bin/activate
python scripts/setup_mts_forwarding.py
```

### Способ 2: Используя curl

```bash
# Настроить переадресацию на внешний SIP
curl -X POST "https://api.exolve.ru/number/v1/SetCallForwarding" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "number_code": 79346620875,
    "call_forwarding_type": 1,
    "call_forwarding_sip": {
      "sip_uri": "55fzatq1dd8@sip.livekit.cloud"
    }
  }'
```

**Важно:** `call_forwarding_type: 1` означает переадресацию на внешний SIP-аккаунт

---

## Контакты поддержки MTS Exolve

Если ничего не помогает:

- **Email:** support@exolve.ru
- **Телефон:** 8 800 250 00 90
- **Чат:** В личном кабинете (правый нижний угол)

Скажите им:
> "Не могу настроить входящие звонки на номер +7 934 662-08-75. 
> Нужно настроить переадресацию на SIP URI: 55fzatq1dd8@sip.livekit.cloud"

---

## После настройки

Когда всё заработает:
1. Обновите PROGRESS.md - отметьте телефонию как работающую
2. Протестируйте разные сценарии звонков
3. Проверьте что логи сохраняются в базу данных
