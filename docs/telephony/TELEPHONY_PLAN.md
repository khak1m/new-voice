# План интеграции телефонии MTS Exolve → LiveKit

## Проблема

MTS Exolve блокирует исходящий SIP трафик на зарубежные IP адреса. LiveKit Cloud находится в Германии, поэтому прямая интеграция невозможна.

**Подтверждение от поддержки MTS Exolve:**
> "Доступ к нашим сервисам и услугам возможен только с IP адресов Российского сегмента. Это значит что любые иностранные сервисы (использующие зарубежные IP) не будут работать с нашей платформой."

## Выбранное решение

**Архитектура: SIP Proxy на VPS в России**

```
┌─────────────┐     ┌─────────────────┐     ┌──────────────────┐     ┌─────────────┐
│  Телефон    │────▶│  MTS Exolve     │────▶│  VPS в России    │────▶│  LiveKit    │
│  (+7 номер) │     │  (SIP trunk)    │     │  (Kamailio)      │     │  Cloud      │
└─────────────┘     └─────────────────┘     └──────────────────┘     └─────────────┘
                                                    │
                                                    ▼
                                            ┌─────────────┐
                                            │ Voice Agent │
                                            │ (Python)    │
                                            └─────────────┘
```

## Компоненты

| Компонент | Роль | Расположение |
|-----------|------|--------------|
| MTS Exolve | SIP провайдер, номер +7 934 662-08-75 | Россия |
| VPS (Kamailio) | SIP Proxy, мост между MTS и LiveKit | Россия (Timeweb/Selectel) |
| LiveKit Cloud | WebRTC платформа, SIP gateway | Германия |
| Voice Agent | Обработка звонков, AI | Нидерланды (текущий сервер) |

## Этапы реализации

---

## ЭТАП 1: Подготовка VPS в России
**Срок: 1 день**
**Статус: [x] ВЫПОЛНЕНО 2026-01-15**

### Результат:
- VPS: Timeweb, 1 CPU, 1GB RAM, 350 руб/мес
- IP: 62.113.37.156
- ОС: Ubuntu 24.04

### 1.1 Аренда VPS
- [ ] Выбрать провайдера: Timeweb / Selectel / REG.RU
- [ ] Минимальные требования: Ubuntu 22.04, 1 CPU, 1GB RAM, публичный IP
- [ ] Стоимость: ~300-500 руб/мес

### 1.2 Базовая настройка
- [ ] Обновить систему: `apt update && apt upgrade -y`
- [ ] Настроить firewall (ufw)
- [ ] Создать пользователя (не root)
- [ ] Настроить SSH ключи

### Тест этапа 1:
```bash
# Проверить доступность VPS
ping <IP_VPS>
ssh user@<IP_VPS>
```

---

## ЭТАП 2: Установка Kamailio
**Срок: 1 день**
**Статус: [x] ВЫПОЛНЕНО 2026-01-15**

### Результат:
- Kamailio 5.7.4 установлен
- rtpengine 11.5.1 установлен для медиа-проксирования
- Порты: 5060/udp (SIP), 10000-20000/udp (RTP)

### 2.1 Установка
```bash
apt install kamailio kamailio-mysql-modules kamailio-tls-modules -y
```

### 2.2 Базовая конфигурация
- [ ] Настроить `/etc/kamailio/kamailio.cfg`
- [ ] Указать listen на публичный IP
- [ ] Настроить логирование

### 2.3 Открыть порты
```bash
ufw allow 5060/udp  # SIP signaling
ufw allow 5061/tcp  # SIP TLS
ufw allow 10000:20000/udp  # RTP media
```

### Тест этапа 2:
```bash
# Проверить что Kamailio запущен
systemctl status kamailio
# Проверить что порт слушает
ss -ulnp | grep 5060
```

---

## ЭТАП 3: Настройка Kamailio как SIP Proxy
**Срок: 2 дня**
**Статус: [x] ВЫПОЛНЕНО 2026-01-15**

### Результат:
- Конфиг: /etc/kamailio/kamailio.cfg
- SIP проксирование на LiveKit Cloud
- rtpengine интеграция для медиа

### 3.1 Конфигурация для проксирования
Создать конфиг который:
- Принимает SIP INVITE от MTS Exolve
- Пересылает на LiveKit Cloud
- Обрабатывает ответы

### 3.2 Пример конфигурации
```
# /etc/kamailio/kamailio.cfg
listen=udp:<IP_VPS>:5060

request_route {
    if (is_method("INVITE")) {
        # Пересылаем на LiveKit
        $du = "sip:+79346620875@<project>.sip.livekit.cloud:5060;transport=udp";
        forward();
    }
}
```

### Тест этапа 3:
```bash
# Отправить тестовый SIP OPTIONS
apt install sipsak -y
sipsak -s sip:test@<IP_VPS>:5060
```

---

## ЭТАП 4: Настройка MTS Exolve
**Срок: 1 день**
**Статус: [x] ВЫПОЛНЕНО 2026-01-15**

### Результат:
- Переадресация: sip:+79346620875@62.113.37.156:5060
- Настроено через личный кабинет MTS Exolve

### 4.1 Изменить переадресацию
- [ ] Зайти в личный кабинет MTS Exolve
- [ ] Изменить SIP URI на: `sip:+79346620875@<IP_VPS>:5060`
- [ ] Или через API:

```python
import requests

headers = {'Authorization': f'Bearer {API_KEY}'}
data = {
    'number_code': 79346620875,
    'forwarding_type': 'unconditional',
    'forwarding_number': f'sip:+79346620875@<IP_VPS>:5060'
}
response = requests.post(
    'https://api.exolve.ru/number/v1/SetCallForwarding',
    json=data,
    headers=headers
)
```

### Тест этапа 4:
```bash
# На VPS смотреть логи Kamailio
tail -f /var/log/kamailio/kamailio.log
# Позвонить на номер +7 934 662-08-75
# Должен появиться SIP INVITE в логах
```

---

## ЭТАП 5: Настройка LiveKit Inbound Trunk
**Срок: 1 день**
**Статус: [x] ВЫПОЛНЕНО 2026-01-15**

### Результат:
- Trunk: MTS Exolve Inbound (ST_ZrCkMpnD5PC)
- Allowed addresses: 62.113.37.156
- SIP URI: sip:55fzatq1dd8.sip.livekit.cloud

### 5.1 Создать Inbound Trunk
В LiveKit Cloud Console:
- [ ] Telephony → Configuration → Create Trunk
- [ ] Указать номер: +79346620875
- [ ] Указать allowed_addresses: [<IP_VPS>]

### 5.2 Создать Dispatch Rule
- [ ] Создать правило маршрутизации на агента
- [ ] Указать room prefix или pin

### Тест этапа 5:
```bash
# Проверить что trunk создан
lk sip trunk list
```

---

## ЭТАП 6: Интеграционное тестирование
**Срок: 1-2 дня**
**Статус: [x] ВЫПОЛНЕНО 2026-01-15**

### Результат:
✅ Звонок проходит от телефона до агента
✅ Агент отвечает голосом
✅ Распознавание речи работает
⚠️ Задержка ~1-3 сек (из-за LLM)

### 6.1 Тест полного пути
- [ ] Запустить агента на сервере
- [ ] Позвонить на +7 934 662-08-75
- [ ] Проверить что звонок доходит до агента
- [ ] Проверить качество звука

### 6.2 Отладка
- [ ] Логи Kamailio: `/var/log/kamailio/kamailio.log`
- [ ] Логи агента: stdout
- [ ] LiveKit Dashboard: статус SIP participant

### Тест этапа 6:
```
Критерии успеха:
✅ Звонок проходит от телефона до агента
✅ Агент отвечает голосом
✅ Распознавание речи работает
✅ Задержка < 500ms
```

---

## ЭТАП 7: Продакшн настройка
**Срок: 2-3 дня**
**Статус: [ ] Не начат**

### 7.1 Безопасность
- [ ] Настроить TLS для SIP
- [ ] Настроить SRTP для медиа
- [ ] Ограничить доступ по IP (только MTS Exolve)

### 7.2 Мониторинг
- [ ] Настроить алерты на падение Kamailio
- [ ] Логирование звонков
- [ ] Метрики качества

### 7.3 Отказоустойчивость
- [ ] Автозапуск Kamailio через systemd
- [ ] Резервный VPS (опционально)

---

## Риски и митигация

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| MTS блокирует и российские IP | Низкая | Уточнить у поддержки заранее |
| Kamailio сложно настроить | Средняя | Использовать готовые конфиги, документацию |
| Проблемы с NAT/RTP | Средняя | Настроить rtpproxy или rtpengine |
| Высокая задержка | Низкая | VPS в Москве, оптимизация маршрутов |

---

## Альтернативный план (если не сработает)

Если MTS Exolve не будет работать даже с российским VPS:

1. **Zadarma** — быстрый MVP за 1 час
   - Зарегистрироваться, купить номер +7
   - Настроить SIP URI forwarding на LiveKit
   - Стоимость: €5-10/мес

2. **Voximplant** — российская платформа
   - Серверы в РФ, нет блокировок
   - callSIP() для переадресации
   - Стоимость: $0.004/мин

---

## Ресурсы

- [Kamailio Documentation](https://www.kamailio.org/w/documentation/)
- [LiveKit SIP Docs](https://docs.livekit.io/sip/)
- [MTS Exolve API](https://lk.exolve.ru/)

---

## История изменений

| Дата | Изменение |
|------|-----------|
| 2026-01-15 | Создан план |
| 2026-01-15 | ✅ Этапы 1-6 выполнены, телефония работает |
