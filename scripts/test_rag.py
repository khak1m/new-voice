#!/usr/bin/env python3
"""
–¢–µ—Å—Ç RAG —Å–∏—Å—Ç–µ–º—ã.

–ó–∞–ø—É—Å–∫:
    python scripts/test_rag.py
"""

import os
import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø—É—Ç—å
sys.path.insert(0, str(Path(__file__).parent.parent))

from dotenv import load_dotenv
load_dotenv()


# –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Äî –ø—Ä–∞–π—Å —Å–∞–ª–æ–Ω–∞
SALON_PRICE_LIST = """
# –ü—Ä–∞–π—Å-–ª–∏—Å—Ç —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã Glamour

## –ü–∞—Ä–∏–∫–º–∞—Ö–µ—Ä—Å–∫–∏–µ —É—Å–ª—É–≥–∏
- –ñ–µ–Ω—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞: 1500 —Ä—É–±
- –ú—É–∂—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞: 800 —Ä—É–±
- –î–µ—Ç—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞: 600 —Ä—É–±
- –û–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ –≤–æ–ª–æ—Å: –æ—Ç 3000 —Ä—É–±
- –ú–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ: –æ—Ç 4000 —Ä—É–±
- –£–∫–ª–∞–¥–∫–∞: 1000 —Ä—É–±

## –ú–∞–Ω–∏–∫—é—Ä –∏ –ø–µ–¥–∏–∫—é—Ä
- –ú–∞–Ω–∏–∫—é—Ä –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π: 1200 —Ä—É–±
- –ú–∞–Ω–∏–∫—é—Ä —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º –≥–µ–ª—å-–ª–∞–∫: 1800 —Ä—É–±
- –ü–µ–¥–∏–∫—é—Ä –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π: 1500 —Ä—É–±
- –ü–µ–¥–∏–∫—é—Ä —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º: 2200 —Ä—É–±
- –ù–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ –Ω–æ–≥—Ç–µ–π: –æ—Ç 3500 —Ä—É–±

## –ö–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏—è
- –ß–∏—Å—Ç–∫–∞ –ª–∏—Ü–∞: 2500 —Ä—É–±
- –ü–∏–ª–∏–Ω–≥: –æ—Ç 2000 —Ä—É–±
- –ú–∞—Å—Å–∞–∂ –ª–∏—Ü–∞: 1500 —Ä—É–±
- –£—Ö–æ–¥ –∑–∞ –∫–æ–∂–µ–π: –æ—Ç 3000 —Ä—É–±

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
- –ë—Ä–æ–≤–∏: –∫–æ—Ä—Ä–µ–∫—Ü–∏—è 500 —Ä—É–±, –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ 700 —Ä—É–±
- –†–µ—Å–Ω–∏—Ü—ã: –Ω–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ –æ—Ç 2500 —Ä—É–±
"""

SALON_FAQ = """
# –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã

## –ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è?
–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É +7 (999) 123-45-67 –∏–ª–∏ —á–µ—Ä–µ–∑ –Ω–∞—à —Å–∞–π—Ç.
–¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –≤ WhatsApp.

## –ì–¥–µ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å?
–ú—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –ø–æ –∞–¥—Ä–µ—Å—É: —É–ª. –ü—É—à–∫–∏–Ω–∞, –¥. 10, 2 —ç—Ç–∞–∂.
–ë–ª–∏–∂–∞–π—à–µ–µ –º–µ—Ç—Ä–æ ‚Äî –ê—Ä–±–∞—Ç—Å–∫–∞—è, 5 –º–∏–Ω—É—Ç –ø–µ—à–∫–æ–º.

## –ö–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã?
–ü—Ä–∏–Ω–∏–º–∞–µ–º –Ω–∞–ª–∏—á–Ω—ã–µ, –∫–∞—Ä—Ç—ã –∏ –ø–µ—Ä–µ–≤–æ–¥—ã –ø–æ –°–ë–ü.

## –ù—É–∂–Ω–∞ –ª–∏ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞?
–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è. –û–ø–ª–∞—Ç–∞ –ø–æ—Å–ª–µ –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥–∏.

## –ú–æ–∂–Ω–æ –ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å?
–î–∞, –Ω–æ –ø—Ä–æ—Å–∏–º –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å –º–∏–Ω–∏–º—É–º –∑–∞ 2 —á–∞—Å–∞ –¥–æ –≤–∏–∑–∏—Ç–∞.

## –ï—Å—Ç—å –ª–∏ —Å–∫–∏–¥–∫–∏?
–î–∞! –°–∫–∏–¥–∫–∞ 10% –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ.
–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º ‚Äî –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–∫–∏–¥–æ–∫.
"""


def test_rag():
    """–¢–µ—Å—Ç RAG —Å–∏—Å—Ç–µ–º—ã."""
    print("=" * 50)
    print("üîç NEW-VOICE 2.0 ‚Äî –¢–µ—Å—Ç RAG —Å–∏—Å—Ç–µ–º—ã")
    print("=" * 50)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º Qdrant
    print("\nüìã –ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Qdrant...")
    
    try:
        from qdrant_client import QdrantClient
        
        host = os.getenv("QDRANT_HOST", "localhost")
        port = int(os.getenv("QDRANT_PORT", "6333"))
        
        client = QdrantClient(host=host, port=port)
        collections = client.get_collections()
        print(f"   ‚úÖ Qdrant –ø–æ–¥–∫–ª—é—á–µ–Ω: {host}:{port}")
        print(f"   üìÅ –ö–æ–ª–ª–µ–∫—Ü–∏–π: {len(collections.collections)}")
        
    except Exception as e:
        print(f"   ‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Qdrant: {e}")
        print("   üí° –£–±–µ–¥–∏—Å—å —á—Ç–æ Qdrant –∑–∞–ø—É—â–µ–Ω: docker-compose up -d")
        return False
    
    # –°–æ–∑–¥–∞—ë–º –º–µ–Ω–µ–¥–∂–µ—Ä –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
    print("\nüìö –°–æ–∑–¥–∞—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π...")
    
    try:
        from src.rag import KnowledgeBaseManager, RAGSearch
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è —Ç–µ—Å—Ç–∞ (–±–µ–∑ ML –º–æ–¥–µ–ª–∏)
        from src.rag.embeddings import get_embedding_provider
        
        # –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å sentence-transformers
        try:
            provider = get_embedding_provider(use_simple=False)
            print("   ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º sentence-transformers")
        except ImportError:
            provider = get_embedding_provider(use_simple=True)
            print("   ‚ö†Ô∏è sentence-transformers –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä")
        
        kb = KnowledgeBaseManager(embedding_provider=provider)
        
    except Exception as e:
        print(f"   ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞: {e}")
        return False
    
    # –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é
    collection_name = "test_salon"
    
    print(f"\nüìÅ –°–æ–∑–¥–∞—é –∫–æ–ª–ª–µ–∫—Ü–∏—é '{collection_name}'...")
    
    # –£–¥–∞–ª—è–µ–º –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if kb.collection_exists(collection_name):
        kb.delete_collection(collection_name)
    
    kb.create_collection(collection_name)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã
    print("\nüìÑ –î–æ–±–∞–≤–ª—è—é –¥–æ–∫—É–º–µ–Ω—Ç—ã...")
    
    chunks1 = kb.add_text(
        collection_name=collection_name,
        text=SALON_PRICE_LIST,
        title="–ü—Ä–∞–π—Å-–ª–∏—Å—Ç",
    )
    print(f"   ‚úÖ –ü—Ä–∞–π—Å-–ª–∏—Å—Ç: {chunks1} —á–∞–Ω–∫–æ–≤")
    
    chunks2 = kb.add_text(
        collection_name=collection_name,
        text=SALON_FAQ,
        title="FAQ",
    )
    print(f"   ‚úÖ FAQ: {chunks2} —á–∞–Ω–∫–æ–≤")
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    info = kb.get_collection_info(collection_name)
    print(f"\nüìä –ö–æ–ª–ª–µ–∫—Ü–∏—è '{collection_name}':")
    print(f"   –¢–æ—á–µ–∫: {info.get('points_count', 'N/A')}")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫
    print("\nüîç –¢–µ—Å—Ç–∏—Ä—É—é –ø–æ–∏—Å–∫...")
    
    rag = RAGSearch(kb_manager=kb)
    
    test_queries = [
        "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –º–∞–Ω–∏–∫—é—Ä",
        "–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–ª–æ–Ω",
        "–∫–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è",
        "–µ—Å—Ç—å –ª–∏ —Å–∫–∏–¥–∫–∏",
        "—Ü–µ–Ω–∞ –Ω–∞ —Å—Ç—Ä–∏–∂–∫—É",
    ]
    
    for query in test_queries:
        print(f"\n   Q: {query}")
        results = rag.search(collection_name, query, top_k=1)
        
        if results:
            best = results[0]
            print(f"   A: {best.content[:100]}...")
            print(f"   Score: {best.score:.2f}")
        else:
            print("   A: –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
    
    # –û—á–∏—Å—Ç–∫–∞
    print(f"\nüßπ –£–¥–∞–ª—è—é —Ç–µ—Å—Ç–æ–≤—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é...")
    kb.delete_collection(collection_name)
    
    print("\n" + "=" * 50)
    print("‚úÖ RAG —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!")
    print("=" * 50)
    
    return True


if __name__ == "__main__":
    success = test_rag()
    sys.exit(0 if success else 1)
